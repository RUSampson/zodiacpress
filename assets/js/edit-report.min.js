var zpEditReport;(function(a){var b;b=zpEditReport={options:{sortableItems:'> *'},reportList:void 0,targetList:void 0,lastSearch:'',init:function(){b.reportList=a('#report-to-edit'),b.targetList=b.reportList,this.jQueryExtensions(),this.attachReportEditListeners(),this.attachQuickSearchListeners(),this.attachTabsPanelListeners(),b.reportList.length&&this.initSortables(),this.initAccessibility(),this.initPreviewing()},jQueryExtensions:function(){a.fn.extend({addSelectedToReport:function(c){if(0===a('#report-to-edit').length)return!1;var d=document.querySelectorAll('#report-to-edit li[id]'),f=[];return Array.prototype.forEach.call(d,function(g){f.push(g.id.replace('report-item-',''))}),this.each(function(){var g=a(this),h={},j=g.find('.tabs-panel-active .categorychecklist li input:checked'),k=/report-item\[([^\]]*)/;return(c=c||b.addReportItemToBottom,!!j.length)&&(g.find('.button-controls .spinner').addClass('is-active'),a(j).each(function(){var l=a(this);-1==f.indexOf(this.value)&&(h[this.value]=l.closest('li').getItemData('add-report-item',this.value))}),Object.keys(h).length?void b.addItemToReport(h,c,function(){j.removeAttr('checked'),g.find('.button-controls .spinner').removeClass('is-active')}):(g.find('.button-controls .spinner').removeClass('is-active'),!1))})},getItemData:function(c,d){c=c||'report-item';var g,f={},h=['report-item-id','report-item-title'];return(d||'report-item'!=c||(d=this.find('.report-item-data-object-id').val()),!d)?f:(this.find('input').each(function(){var j;for(g=h.length;g--;)'report-item'==c?j=h[g]+'['+d+']':'add-report-item'==c&&(j='report-item['+d+']['+h[g]+']'),this.name&&j==this.name&&(f[h[g]]=this.value)}),f)},setItemData:function(c){var f=a('.report-item-data-object-id',this).val();return f?(this.find('input').each(function(){var h,g=a(this);a.each(c,function(j,k){h=j+'['+f+']',h==g.attr('name')&&g.val(k)})}),this):this}})},moveReportItem:function(c,d){var f,g=a('#report-to-edit li'),h=g.length,j=c.parents('li.report-item'),k=parseInt(j.index(),10);switch(d){case'up':if(f=k-1,0===k)break;j.detach().insertBefore(g.eq(f));break;case'down':if(h===k+1)break;j.detach().insertAfter(g.eq(k+1));break;case'top':if(0===k)break;j.detach().insertBefore(g.eq(0));}c.focus(),b.refreshKeyboardAccessibility(),b.refreshAdvancedAccessibility()},initAccessibility:function(){b.refreshKeyboardAccessibility(),b.refreshAdvancedAccessibility(),b.reportList.on('mouseenter.refreshAccessibility focus.refreshAccessibility touchstart.refreshAccessibility','.report-item',function(){b.refreshAdvancedAccessibilityOfItem(a(this).find('a.item-edit'))}),b.reportList.on('click','a.item-edit',function(){b.refreshAdvancedAccessibilityOfItem(a(this))}),b.reportList.on('click','.reports-move',function(){var c=a(this),d=c.data('dir');'undefined'!=typeof d&&b.moveReportItem(a(this).parents('li.report-item').find('a.item-edit'),d)})},refreshAdvancedAccessibilityOfItem:function(c){if(!0===a(c).data('needs_accessibility_refresh')){var d,f,g=a(c),h=g.closest('li.report-item').first(),j=g.closest('.report-item-handle').find('.report-item-title').text(),k=parseInt(h.index(),10),l=a('#report-to-edit li').length,m=h.nextAll().length;h.find('.field-move').toggle(1<l),0!==k&&(d=h.find('.reports-move-up'),d.attr('aria-label',reports.moveUp).css('display','inline')),0!==k&&(d=h.find('.reports-move-top'),d.attr('aria-label',reports.moveToTop).css('display','inline')),k+1!==l&&0!==k&&(d=h.find('.reports-move-down'),d.attr('aria-label',reports.moveDown).css('display','inline')),0===k&&0!==m&&(d=h.find('.reports-move-down'),d.attr('aria-label',reports.moveDown).css('display','inline')),f=reports.reportFocus.replace('%1$s',j).replace('%2$d',k+1).replace('%3$d',l),g.attr('aria-label',f),g.data('needs_accessibility_refresh',!1)}},refreshAdvancedAccessibility:function(){a('.report-item-settings .field-move .reports-move').hide(),a('a.item-edit').data('needs_accessibility_refresh',!0),a('.report-item-edit-active a.item-edit').each(function(){b.refreshAdvancedAccessibilityOfItem(this)})},refreshKeyboardAccessibility:function(){a('a.item-edit').off('focus').on('focus',function(){a(this).off('keydown').on('keydown',function(c){var d,f=a(this),g=f.parents('li.report-item'),h=g.attr('id').replace('edit-report-item-title-','');if((38==c.which||40==c.which)&&(f.off('keydown'),1!==a('#report-to-edit li').length)){switch(d={38:'up',40:'down'},d[c.which]){case'up':b.moveReportItem(f,'up');break;case'down':b.moveReportItem(f,'down');}return a('#edit-'+h).focus(),!1}})})},initPreviewing:function(){a('#report-to-edit').on('change input','.edit-report-item-title',function(c){var f,g,d=a(c.currentTarget);f=d.val(),g=d.closest('.report-item').find('.report-item-title'),f&&g.text(f)})},initSortables:function(){function c(k){f=k.placeholder.next('.report-item'),f[0]==k.item[0]&&(f=f.next('.report-item')),g=f.length?f.offset().top+f.height()/3:0}var d,f,g,h;0!==a('#report-to-edit li').length&&a('.drag-instructions').show(),b.reportList.sortable({handle:'.report-item-handle',placeholder:'sortable-placeholder',items:b.options.sortableItems,start:function(k,l){var m,n,o;m=l.helper.outerHeight(),h=m,m-=2,l.placeholder.height(m),n=l.helper.find('.report-item-handle').outerWidth(),n-=2,l.placeholder.width(n),o=l.placeholder.next('.report-item'),o.css('margin-top',h+'px'),l.placeholder.detach(),a(this).sortable('refresh'),l.item.after(l.placeholder),o.css('margin-top',0),c(l)},stop:function(k,l){l.item[0].style.top=0,b.refreshKeyboardAccessibility(),b.refreshAdvancedAccessibility()},change:function(k,l){l.placeholder.parent().hasClass('report')||(d.length?d.after(l.placeholder):b.reportList.prepend(l.placeholder)),c(l)},sort:function(k,l){var m=l.helper.offset();g&&m.top+h>g&&(f.after(l.placeholder),c(l),a(this).sortable('refreshPositions'))}})},attachReportEditListeners:function(){var c=this;a('#update-zp-report').bind('click',function(d){if(d.target&&d.target.className){if(-1!=d.target.className.indexOf('item-edit'))return c.eventOnClickEditLink(d.target);if(-1!=d.target.className.indexOf('report-save'))return c.eventOnClickReportSave(d.target);if(-1!=d.target.className.indexOf('item-delete'))return c.eventOnClickReportItemDelete(d.target);if(-1!=d.target.className.indexOf('item-cancel'))return c.eventOnClickCancelLink(d.target)}}),a('.zpcustomdiv input[type="text"]').keypress(function(d){var f=a(this.closest('.zpcustomdiv'));if(f.removeClass('form-invalid'),13===d.keyCode){d.preventDefault();var g=f.find('.submit-add-to-report');g.click()}})},attachQuickSearchListeners:function(){var c;a('#zp-report-meta').on('submit',function(d){d.preventDefault()}),a('#zp-report-meta').on('input','.quick-search',function(){var d=a(this);c&&clearTimeout(c),c=setTimeout(function(){b.updateQuickSearchResults(d)},500)}).on('blur','.quick-search',function(){b.lastSearch=''})},updateQuickSearchResults:function(c){var d,f,h=c.val();h.length<2||b.lastSearch==h||(b.lastSearch=h,d=c.parents('.tabs-panel'),f={action:'zp-aspects-quick-search','zp-edit-report-column-nonce':a('#zp-edit-report-column-nonce').val(),q:h},a('.spinner',d).addClass('is-active'),a.post(ajaxurl,f,function(j){b.processQuickSearchQueryResponse(j,d)}))},addCustomItem:function(c,d){var f=d.replace('submit-zpcustom',''),g='custom-'+f+'-item',h=a('#'+g).val();return c=c||b.addReportItemToBottom,''===h?(a('#zpcustom'+f).addClass('form-invalid'),!1):void(a('.zpcustomdiv .spinner').addClass('is-active'),this.addTextToReport(f,h,c,function(){a('.zpcustomdiv .spinner').removeClass('is-active'),a('#'+g).val('').blur()}))},addTextToReport:function(c,d,f,g){f=f||b.addReportItemToBottom,g=g||function(){};var h=document.querySelectorAll('#report-to-edit li[id]'),j=[],k='_'+c;if(Array.prototype.forEach.call(h,function(m){var n=m.id.replace('report-item-','');n.endsWith(k)&&j.push(n.replace(k,''))}),0<j.length){var l=Math.max(...j);l++}else l=1;c=l+'_'+c,b.addItemToReport({'-1':{'report-item-id':c,'report-item-title':d}},f,g)},addItemToReport:function(c,d,f){var g={action:'add-report-item','zp-edit-report-column-nonce':a('#zp-edit-report-column-nonce').val(),'report-item':c};d=d||function(){},f=f||function(){},a.post(ajaxurl,g,function(h){var j=a('#report-instructions');h=a.trim(h),d(h,g),a('li.pending').hide().fadeIn('slow'),a('.drag-instructions').show(),!j.hasClass('report-instructions-inactive')&&j.siblings().length&&j.addClass('report-instructions-inactive'),f(),a('li.pending').removeClass('pending')})},addReportItemToBottom:function(c){var d=a(c);d.appendTo(b.targetList),b.refreshKeyboardAccessibility(),b.refreshAdvancedAccessibility()},attachTabsPanelListeners:function(){a('#report-settings-column').bind('click',function(c){var d,f,g=a(c.target);if(g.hasClass('aspects-tab-link'))d=g.data('type'),f=g.parents('.accordion-section-content').first(),a('input',f).removeAttr('checked'),a('.tabs-panel-active',f).removeClass('tabs-panel-active').addClass('tabs-panel-inactive'),a('#'+d,f).removeClass('tabs-panel-inactive').addClass('tabs-panel-active'),a('.tabs',f).removeClass('tabs'),g.parent().addClass('tabs'),a('.quick-search',f).focus(),f.find('.tabs-panel-active .report-item-title').length?f.removeClass('has-no-report-item'):f.addClass('has-no-report-item'),c.preventDefault();else if(g.hasClass('submit-add-to-report'))return c.target.id&&-1!=c.target.id.indexOf('submit-zpcustom')?b.addCustomItem(b.addReportItemToBottom,c.target.id):c.target.id&&-1!=c.target.id.indexOf('submit-')&&a('#'+c.target.id.replace(/submit-/,'')).addSelectedToReport(b.addReportItemToBottom),!1})},eventOnClickEditLink:function(c){var d,f,g=/#(.*)$/.exec(c.href);if(g&&g[1]&&(d=a('#'+g[1]),f=d.parent(),0!==f.length))return f.hasClass('report-item-edit-inactive')?(!d.data('report-item-data')&&d.data('report-item-data',d.getItemData()),d.slideDown('fast'),f.removeClass('report-item-edit-inactive').addClass('report-item-edit-active')):(d.slideUp('fast'),f.removeClass('report-item-edit-active').addClass('report-item-edit-inactive')),!1},eventOnClickCancelLink:function(c){var d=a(c).closest('.report-item-settings'),f=a(c).closest('.report-item');return f.removeClass('report-item-edit-active').addClass('report-item-edit-inactive'),d.setItemData(d.data('report-item-data')).hide(),!1},eventOnClickReportSave:function(){var c=document.getElementById('report-name'),d=c.value.trim();if(!d||2>d.length)return c.parentNode.classList.add('form-invalid'),!1;window.onbeforeunload=null;var g,f=JSON.stringify(a('#update-zp-report').serializeArray());return g={action:'zp_update_report','report-data':f,'update-report-nonce':a('#update-zp-report-nonce').val()},a.post(ajaxurl,g,function(h){h.success&&a('#update-zp-report').submit()}),!1},eventOnClickReportItemDelete:function(c){var d=c.id.replace('delete-','');return b.removeReportItem(a('#report-item-'+d)),!1},processQuickSearchQueryResponse:function(c,d){var f=a('<div>').html(c).find('li'),g=d.closest('.accordion-section-content');return f.length?void(a('.categorychecklist',d).html(f),a('.spinner',d).removeClass('is-active'),g.removeClass('has-no-report-item')):(a('.categorychecklist',d).html('<li><p>'+reports.noResultsFound+'</p></li>'),a('.spinner',d).removeClass('is-active'),void g.addClass('has-no-report-item'))},removeReportItem:function(c){c.addClass('deleting').animate({opacity:0,height:0},350,function(){var d=a('#report-instructions');c.remove(),0===a('#report-to-edit li').length&&(a('.drag-instructions').hide(),d.removeClass('report-instructions-inactive')),b.refreshAdvancedAccessibility()})}},a(document).ready(function(){zpEditReport.init()})})(jQuery);
